# SPDX-FileCopyrightText: 2025 Juan Manuel MÃ©ndez Rey
# SPDX-License-Identifier: GPL-3.0-or-later

# Load required modules
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so

# Rate limiting using built-in Apache modules
# Enable logging module for rate limiting
LoadModule log_config_module modules/mod_log_config.so

# Custom log format for monitoring
LogFormat "%h %l %u %t \"%r\" %>s %O \"%{Referer}i\" \"%{User-Agent}i\"" combined
CustomLog /usr/local/apache2/logs/access.log combined

# Basic rate limiting via RewriteMap (simpler alternative)
RewriteEngine On
# Limit connections per IP using environment variables
SetEnvIfNoCase Remote_Addr "^(.*)$" RATE_LIMIT_IP=$1

# Listen on HTTPS
Listen 443
ServerName conquer.vejeta.com

# HTTP virtual host - handle Let's Encrypt challenges and redirect to HTTPS
<VirtualHost *:80>
    ServerName conquer.vejeta.com
    DocumentRoot /var/lib/letsencrypt

    # Allow Let's Encrypt challenges
    <Directory "/var/lib/letsencrypt">
        Require all granted
        AllowOverride None
        Options None
    </Directory>

    # Handle ACME challenges
    Alias /.well-known/acme-challenge /var/lib/letsencrypt/.well-known/acme-challenge
    <Directory "/var/lib/letsencrypt/.well-known/acme-challenge">
        Require all granted
        AllowOverride None
        Options None
    </Directory>

    # Redirect everything else to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [R=301,L]
</VirtualHost>

# HTTPS virtual host for production
<VirtualHost *:443>
    ServerName conquer.vejeta.com

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/certs/live/conquer.vejeta.com/fullchain.pem"
    SSLCertificateKeyFile "/usr/local/apache2/conf/certs/live/conquer.vejeta.com/privkey.pem"

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off
    SSLSessionTickets off

    # Enhanced security headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options DENY
    Header always set X-Content-Type-Options nosniff
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' wss:; font-src 'self'"

    # Hide server information
    ServerTokens Prod
    ServerSignature Off

    # Rate limiting per IP for game access
    <Location />
        # Allow max 10 requests per minute per IP
        <RequireAll>
            Require all granted
            # Additional rate limiting via mod_evasive above
        </RequireAll>
    </Location>

    # Enable rewrite engine for WebSocket upgrade
    RewriteEngine on

    # WebSocket upgrade handling
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://conquer-production:7681/$1" [P,L]

    # Regular HTTP proxy
    ProxyPreserveHost On
    ProxyPass /ws ws://conquer-production:7681/ws
    ProxyPassReverse /ws ws://conquer-production:7681/ws
    ProxyPass / http://conquer-production:7681/
    ProxyPassReverse / http://conquer-production:7681/

    # WebSocket proxy settings
    ProxyTimeout 3600
    ProxyPassMatch ^/(.*) http://conquer-production:7681/$1
</VirtualHost>