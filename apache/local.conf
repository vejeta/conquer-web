# SPDX-FileCopyrightText: 2025 Juan Manuel MÃ©ndez Rey
# SPDX-License-Identifier: GPL-3.0-or-later

# Load required modules
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_wstunnel_module modules/mod_proxy_wstunnel.so

# Lighter rate limiting for local development
# Enable logging for monitoring
LoadModule log_config_module modules/mod_log_config.so

# Basic logging (lighter for development)
LogFormat "%h %t \"%r\" %>s" simple
CustomLog /usr/local/apache2/logs/access.log simple

# Minimal rate limiting for local development
RewriteEngine On

# Listen on HTTPS
Listen 443
ServerName conquer.local

# HTTP -> HTTPS redirect
<VirtualHost *:80>
    ServerName conquer.local
    Redirect permanent / https://conquer.local/
</VirtualHost>

# HTTPS virtual host for local development
<VirtualHost *:443>
    ServerName conquer.local

    SSLEngine on
    SSLCertificateFile "/usr/local/apache2/conf/certs/live/conquer.local/fullchain.pem"
    SSLCertificateKeyFile "/usr/local/apache2/conf/certs/live/conquer.local/privkey.pem"

    # Allow self-signed certificates in development
    SSLVerifyClient none
    SSLVerifyDepth 0

    # Enable rewrite engine for WebSocket upgrade
    RewriteEngine on

    # WebSocket upgrade handling
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://conquer-local:7681/$1" [P,L]

    # Regular HTTP proxy
    ProxyPreserveHost On
    ProxyPass /ws ws://conquer-local:7681/ws
    ProxyPassReverse /ws ws://conquer-local:7681/ws
    ProxyPass / http://conquer-local:7681/
    ProxyPassReverse / http://conquer-local:7681/

    # WebSocket proxy settings
    ProxyTimeout 3600
    ProxyPassMatch ^/(.*) http://conquer-local:7681/$1
</VirtualHost>